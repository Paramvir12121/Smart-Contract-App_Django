<!DOCTYPE html>
<html>
  <head>
    <title>SMART CONTRACT TEST</title>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7-rc.0/web3.min.js"
    ></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
      crossorigin="anonymous"
    />
    <style>
      body {
        background-color: rgba(225, 224, 224, 0.815);
        /* font-size: 20px; */
        text-align: center;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
      <a class="navbar-brand" href="#">CaribFarm</a>
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item active">
            <a class="nav-link" href="{%url 'home'%}">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{%url 'mainPage'%}">Blockchain</a>
          </li>
        </ul>
        <ul class="navbar-nav justify-content-end">
            <a class="nav-link " href="{% url 'signup' %}">Signup</a>
          </li>
        </ul>
      </div>
    </nav>
    <br />
    <div class="Container">
      <button type="button" class="btn btn-primary" onclick="connectMetamask()">
        LOGIN
      </button>
      <br />
      <p id="accountArea">Connection Status: NOT CONNECTED to Metamask</p>
    </div>
    <button type="button" class="btn btn-primary" onclick="connectContract()">
      CONNECT TO CONTRACT
    </button>
    <br />
    <p id="contractArea">Connection Status: NOT CONNECTED to Smart Contract</p>

    <button type="button" class="btn btn-primary" onclick="readWord()">
      GET DATA FROM CONTRACT
    </button>
    <br />
    <div class="container text-center" style="width: 30rem">
      <div class="row">
        <div class="col">
          <p id="farmerNameArea"></p>
        </div>
        <div class="col">
          <p id="farmerIdArea"></p>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <p id="lenderNameArea"></p>
        </div>
        <div class="col">
          <p id="lenderIdArea"></p>
        </div>
      </div>
      <div class="col-md m-3">
        <p id="amountArea"></p>
      </div>
    </div>
    <p id="dataArea" m-3>Data Status: NO Data from Smart Contract</p>

    <div m-3>
      <button type="button" class="btn btn-primary" onclick="changeWord()">
        BORROW
      </button>
    </div>
    <br />
    <div m-3>
      <input type="text" id="inputArea" m-3 />
    </div>

    <script>
      let account;
      let id;
      let output
      let accountFoundFlag = false
      const connectMetamask = async () => {
        let accountList = {{ account_list_json|safe }};
        if (window.ethereum !== "undefined") {
          const accounts = await ethereum.request({
            method: "eth_requestAccounts",
          });
          account = accounts[0].trim().toLowerCase();
          console.log("account pulled ", account)
          for (let x in accountList) {
            member_id = accountList[x].account_id.trim().toLowerCase();
          console.log("database value is ",member_id);
          console.log(member_id === account)
          if (member_id === account) {
            output = `Account is: ${account} \n Logged in as ${accountList[x].fname} ${accountList[x].lname}`
            id = accountList[x].id
            accountFoundFlag = (member_id === account)
            break
          }
          else{
            output = "Account Not Found"
          }}
          document.getElementById(
            "accountArea"
          ).innerHTML = output ;

          }
      };

      const connectContract = async () => {
        const ABI = [
          {
            inputs: [
              {
                internalType: "string",
                name: "_word",
                type: "string",
              },
            ],
            name: "changeAmount",
            outputs: [],
            stateMutability: "nonpayable",
            type: "function",
          },
          {
            inputs: [],
            name: "farmerId",
            outputs: [
              {
                internalType: "string",
                name: "",
                type: "string",
              },
            ],
            stateMutability: "view",
            type: "function",
          },
          {
            inputs: [],
            name: "farmerName",
            outputs: [
              {
                internalType: "string",
                name: "",
                type: "string",
              },
            ],
            stateMutability: "view",
            type: "function",
          },
          {
            inputs: [],
            name: "getAmount",
            outputs: [
              {
                internalType: "string",
                name: "",
                type: "string",
              },
            ],
            stateMutability: "view",
            type: "function",
          },
          {
            inputs: [],
            name: "lenderId",
            outputs: [
              {
                internalType: "string",
                name: "",
                type: "string",
              },
            ],
            stateMutability: "view",
            type: "function",
          },
          {
            inputs: [],
            name: "lenderName",
            outputs: [
              {
                internalType: "string",
                name: "",
                type: "string",
              },
            ],
            stateMutability: "view",
            type: "function",
          },
        ];
        const Address = "0x92AdEf588F76f7d484D2ff1fc35C6DeD23Ff5ebC";
        window.web3 = await new Web3(window.ethereum);
        window.contract = await new window.web3.eth.Contract(ABI, Address);
        document.getElementById("contractArea").innerHTML =
          "Connection Status: Success";
      };

      const readWord = async () => {
        const data = await window.contract.methods.getAmount().call();
        document.getElementById("dataArea").innerHTML = `Amount is: ${data}`;
        const farmerName = await window.contract.methods.farmerName().call();
        const farmerId = await window.contract.methods.farmerId().call();
        const lenderName = await window.contract.methods.lenderName().call();
        const lenderId = await window.contract.methods.lenderId().call();
          
        document.getElementById(
          "farmerNameArea"
        ).innerHTML = `Borrower Name: ${farmerName}`;
        document.getElementById("farmerIdArea").innerHTML = farmerId;
        document.getElementById(
          "lenderNameArea"
        ).innerHTML = `Lender Name: ${lenderName}`;
        document.getElementById("lenderIdArea").innerHTML = lenderId;
      };

      const changeWord = async () => {
        const myEntry = document.getElementById("inputArea").value;
        await window.contract.methods
          .changeAmount(myEntry)
          .send({ from: account });
      };
    </script>
    </div>
  </body>
</html>
